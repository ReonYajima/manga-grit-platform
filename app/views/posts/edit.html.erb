<!DOCTYPE html>
<html>
<head>
  <title>æŠ•ç¨¿ç·¨é›† - <%= @post.manga_title %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h2">æŠ•ç¨¿ç·¨é›†</h1>
        <p class="text-muted">ã‚¸ãƒ£ãƒ³ãƒ«: <%= @post.genre.name %></p>
      </div>
      <div>
        <%= link_to "â† æˆ»ã‚‹", [@post.genre, @post], class: "btn btn-outline-secondary" %>
      </div>
    </div>

    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card">
          <div class="card-body">
            <%= form_with(model: [@post.genre, @post], local: true) do |form| %>
              <% if @post.errors.any? %>
                <div class="alert alert-danger">
                  <h5><%= pluralize(@post.errors.count, "error") %> prohibited this post from being saved:</h5>
                  <ul class="mb-0">
                    <% @post.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              <% end %>

              <div class="mb-3">
                <%= form.label :manga_title, "ãƒãƒ³ã‚¬ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆï¼‰", class: "form-label" %>
                <%= form.text_field :manga_title, class: "form-control" %>
              </div>

              <div class="mb-3">
                <%= form.label :content, "æŠ•ç¨¿å†…å®¹ï¼ˆå¿…é ˆï¼‰", class: "form-label" %>
                <%= form.text_area :content, rows: 8, class: "form-control" %>
                <div class="form-text">ã‚°ãƒªãƒƒãƒˆï¼ˆã‚„ã‚ŠæŠœãåŠ›ï¼‰ã«é–¢é€£ã™ã‚‹å†…å®¹ã‚’æ›¸ã„ã¦ãã ã•ã„</div>
              </div>

              <div class="mb-4">
                <%= form.label :tag_list, "ã‚¿ã‚°", class: "form-label" %>
                <%= form.text_field :tag_list, class: "form-control", 
                    placeholder: "ä¾‹: åŠªåŠ›, ç¶™ç¶š, æˆé•· (ã‚«ãƒ³ãƒã§åŒºåˆ‡ã£ã¦å…¥åŠ›)" %>
                <div class="form-text">é–¢é€£ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
              </div>

              <hr class="my-4">

              <% if @post.image.attached? %>
                <div class="mb-4">
                  <h6>ç¾åœ¨ã®ç”»åƒã¨å‡ºå…¸æƒ…å ±</h6>
                  <div class="card">
                    <div class="card-body">
                      <%= image_tag url_for(@post.image), 
                          class: "img-thumbnail mb-3", 
                          style: "max-width: 300px; max-height: 300px; object-fit: cover;" %>
                      
                      <% if @post.manga_author.present? %>
                        <p class="mb-2">
                          <strong>ğŸ“– å‡ºå…¸ï¼š</strong><%= @post.formatted_citation %>
                        </p>
                      <% end %>
                      
                      <div class="form-check">
                        <%= check_box_tag "post[remove_image]", "1", false, 
                            class: "form-check-input", id: "remove_image" %>
                        <%= label_tag "remove_image", "ã“ã®ç”»åƒã¨å‡ºå…¸æƒ…å ±ã‚’å‰Šé™¤", 
                            class: "form-check-label text-danger" %>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>

              <div class="mb-4">
                <h5 class="mb-3">ç”»åƒã‚’å¤‰æ›´ï¼ˆä»»æ„ï¼‰</h5>
                
                <div class="alert alert-warning">
                  <strong>âš ï¸ è‘—ä½œæ¨©ã«ã¤ã„ã¦</strong><br>
                  ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å ´åˆã¯ã€è‘—ä½œæ¨©æ³•ç¬¬35æ¡ã«åŸºã¥ãã€<strong>1ã‚³ãƒã®ã¿</strong>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™ã€‚<br>
                  å‡ºå…¸æƒ…å ±ï¼ˆè‘—è€…åã€å‡ºç‰ˆç¤¾ã€å·»æ•°ã€ãƒšãƒ¼ã‚¸æ•°ï¼‰ã®å…¥åŠ›ãŒå¿…é ˆã¨ãªã‚Šã¾ã™ã€‚
                </div>

                <%= form.label :image, "æ–°ã—ã„ç”»åƒï¼ˆ1ã‚³ãƒã®ã¿ã€5MBã¾ã§ï¼‰", class: "form-label" %>
                <%= form.file_field :image, accept: "image/*", 
                    class: "form-control", id: "image-upload" %>
                <div id="image-preview" class="mt-2"></div>
              </div>

              <div id="copyright-fields" style="<%= 'display: block;' if @post.image.attached? %>">
                <h6 class="mb-3 text-danger">âš ï¸ å‡ºå…¸æƒ…å ±ï¼ˆç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã¯å¿…é ˆï¼‰</h6>
                
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <%= form.label :manga_author, "è‘—è€…åï¼ˆå¿…é ˆï¼‰", class: "form-label" %>
                    <%= form.text_field :manga_author, class: "form-control", 
                        placeholder: "ä¾‹: å°¾ç”°æ „ä¸€éƒ" %>
                  </div>

                  <div class="col-md-6 mb-3">
                    <%= form.label :manga_publisher, "å‡ºç‰ˆç¤¾ï¼ˆå¿…é ˆï¼‰", class: "form-label" %>
                    <%= form.text_field :manga_publisher, class: "form-control", 
                        placeholder: "ä¾‹: é›†è‹±ç¤¾" %>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <%= form.label :manga_volume, "å·»æ•°ï¼ˆå¿…é ˆï¼‰", class: "form-label" %>
                    <%= form.number_field :manga_volume, class: "form-control", 
                        placeholder: "ä¾‹: 1", min: 1 %>
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <%= form.label :manga_page, "ãƒšãƒ¼ã‚¸æ•°ï¼ˆå¿…é ˆï¼‰", class: "form-label" %>
                    <%= form.number_field :manga_page, class: "form-control", 
                        placeholder: "ä¾‹: 45", min: 1 %>
                  </div>
                </div>
              </div>

              <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <%= form.submit "æ›´æ–°ã™ã‚‹", class: "btn btn-primary me-md-2" %>
                <%= link_to "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", [@post.genre, @post], class: "btn btn-outline-secondary" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  document.getElementById('image-upload').addEventListener('change', function(e) {
    const preview = document.getElementById('image-preview');
    const copyrightFields = document.getElementById('copyright-fields');
    preview.innerHTML = '';
    
    if (this.files && this.files[0]) {
      const file = this.files[0];
      
      if (file.size > 5 * 1024 * 1024) {
        alert(file.name + ' ã¯5MBã‚’è¶…ãˆã¦ã„ã¾ã™');
        this.value = '';
        return;
      }

      copyrightFields.style.display = 'block';

      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.className = 'img-thumbnail';
        img.style.maxWidth = '300px';
        img.style.maxHeight = '300px';
        img.style.objectFit = 'cover';
        preview.appendChild(img);
      }
      reader.readAsDataURL(file);
    }
  });

  // ç”»åƒå‰Šé™¤ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®åˆ¶å¾¡
  const removeCheckbox = document.getElementById('remove_image');
  if (removeCheckbox) {
    removeCheckbox.addEventListener('change', function() {
      const copyrightFields = document.getElementById('copyright-fields');
      if (this.checked) {
        copyrightFields.style.display = 'none';
      } else {
        copyrightFields.style.display = 'block';
      }
    });
  }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>