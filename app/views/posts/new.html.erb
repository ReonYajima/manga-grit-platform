<!DOCTYPE html>
<html>
<head>
  <title>新規投稿 - <%= @genre.name %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h2">新規投稿</h1>
        <p class="text-muted">ジャンル: <%= @genre.name %></p>
      </div>
      <div>
        <%= link_to "← 戻る", @genre, class: "btn btn-outline-secondary" %>
      </div>
    </div>

    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card">
          <div class="card-body">
            <%= form_with(model: [@genre, @post], local: true) do |form| %>
              <% if @post.errors.any? %>
                <div class="alert alert-danger">
                  <h5><%= pluralize(@post.errors.count, "error") %> prohibited this post from being saved:</h5>
                  <ul class="mb-0">
                    <% @post.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              <% end %>

              <div class="mb-3">
                <%= form.label :manga_title, "マンガタイトル（必須）", class: "form-label" %>
                <%= form.text_field :manga_title, class: "form-control", placeholder: "例: ONE PIECE" %>
              </div>

              <div class="mb-3">
                <%= form.label :content, "投稿内容（必須）", class: "form-label" %>
                <%= form.text_area :content, rows: 8, class: "form-control", 
                    placeholder: "印象に残ったシーンやセリフ、そこから学んだことを書いてください...（50文字以上）" %>
                <div class="form-text">グリット（やり抜く力）に関連する内容を書いてください</div>
              </div>

              <div class="mb-4">
                <%= form.label :tag_list, "タグ", class: "form-label" %>
                <%= form.text_field :tag_list, class: "form-control", 
                    placeholder: "例: 努力, 継続, 成長 (カンマで区切って入力)" %>
                <div class="form-text">関連するキーワードをカンマ区切りで入力してください</div>
              </div>

              <hr class="my-4">

              <div class="mb-4">
                <h5 class="mb-3">画像と出典情報（任意）</h5>
                
                <div class="alert alert-warning">
                  <strong>⚠️ 著作権について</strong><br>
                  画像をアップロードする場合は、著作権法第35条に基づき、<strong>1コマのみ</strong>アップロード可能です。<br>
                  出典情報（著者名、出版社、巻数、ページ数）の入力が必須となります。
                </div>

                <%= form.label :image, "画像（1コマのみ、5MBまで）", class: "form-label" %>
                <%= form.file_field :image, accept: "image/*", 
                    class: "form-control", id: "image-upload" %>
                <div id="image-preview" class="mt-2"></div>
              </div>

              <div id="copyright-fields" style="display: none;">
                <h6 class="mb-3 text-danger">⚠️ 出典情報（画像アップロード時は必須）</h6>
                
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <%= form.label :manga_author, "著者名（必須）", class: "form-label" %>
                    <%= form.text_field :manga_author, class: "form-control", 
                        placeholder: "例: 尾田栄一郎" %>
                  </div>

                  <div class="col-md-6 mb-3">
                    <%= form.label :manga_publisher, "出版社（必須）", class: "form-label" %>
                    <%= form.text_field :manga_publisher, class: "form-control", 
                        placeholder: "例: 集英社" %>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <%= form.label :manga_volume, "巻数（必須）", class: "form-label" %>
                    <%= form.number_field :manga_volume, class: "form-control", 
                        placeholder: "例: 1", min: 1 %>
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <%= form.label :manga_page, "ページ数（必須）", class: "form-label" %>
                    <%= form.number_field :manga_page, class: "form-control", 
                        placeholder: "例: 45", min: 1 %>
                  </div>
                </div>
              </div>

              <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <%= form.submit "投稿する", class: "btn btn-primary me-md-2" %>
                <%= link_to "キャンセル", @genre, class: "btn btn-outline-secondary" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  document.getElementById('image-upload').addEventListener('change', function(e) {
    const preview = document.getElementById('image-preview');
    const copyrightFields = document.getElementById('copyright-fields');
    preview.innerHTML = '';
    
    if (this.files && this.files[0]) {
      const file = this.files[0];
      
      if (file.size > 5 * 1024 * 1024) {
        alert(file.name + ' は5MBを超えています');
        this.value = '';
        copyrightFields.style.display = 'none';
        return;
      }

      copyrightFields.style.display = 'block';

      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.className = 'img-thumbnail';
        img.style.maxWidth = '300px';
        img.style.maxHeight = '300px';
        img.style.objectFit = 'cover';
        preview.appendChild(img);
      }
      reader.readAsDataURL(file);
    } else {
      copyrightFields.style.display = 'none';
    }
  });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>